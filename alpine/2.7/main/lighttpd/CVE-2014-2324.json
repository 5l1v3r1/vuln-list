{
  "IssueID": 2763,
  "VulnerabilityID": "CVE-2014-2324",
  "Release": "2.7",
  "Package": "lighttpd",
  "Repository": "main",
  "FixedVersion": "1.4.35-r0",
  "Subject": "[v2.7] lighttpd:  mod_mysql_vhost SQL injection (CVE-2014-2323, CVE-2014-2324) ",
  "Description": "https://bugzilla.redhat.com/show_bug.cgi?id=1075703\r\nhttp://seclists.org/oss-sec/2014/q1/561\r\nhttp://download.lighttpd.net/lighttpd/security/lighttpd_sa_2014_01.txt\r\n\r\nh2. Description\r\n\r\nJann Horn \u003cjann@thejh.net\u003e reported a MySQL injection vulnerability through \r\na combination of two bugs:\r\n\r\n* request_check_hostname is too lax: it allows any host names starting with\r\n  [ipv6-address] followed by anything but a colon, for example:\r\n\r\n  GET /etc/passwd HTTP/1.1\r\n  Host: [::1]' UNION SELECT '/\r\n\r\n* mod_mysql_vhost doesn't perform any quoting; it just replaces ? in the \r\n  query string with the hostname.\r\n\r\n\r\nmod_evhost and mod_simple_vhost are vulnerable in a limited way too; a \r\npattern: evhost.path-pattern = \"/var/www/%0/\" with a host \"[]/../../../\" \r\nleads to document root of \"/var/www/[]/../../../\", but as \"/var/www/[]\" \r\nusually doesn't exists this fails (this might depend on the operating \r\nsystem in use).\r\nIf there exist directories like \"/var/www/[...]\" for IPv6 addresses as \r\nhost names (or a user can create them) mod_evhost and mod_simple_vhost \r\nare vulnerable too.\r\n\r\nmod_status, mod_webdav and a global redirect handler use the host name \r\nwithout escaping too; in these cases the client just gets the broken data \r\nback - the attacker doesn't gain anything here.\r\n\r\nh2. Detailed analysis\r\n\r\nQuoting the report from Jann Horn:\r\n\u003e Have a look at this special case of request_check_hostname in request.c:\r\n[ see http://git.lighttpd.net/lighttpd/lighttpd-1.x.git/tree/src/request.c?id=lighttpd-1.4.34#n41 ]\r\n\u003e So, when the hostname starts with a '[', only this block of code validates the \r\n\u003e user-supplied hostname. First, the code incorrectly commented with \r\n\u003e \"/* check portnumber */\" checks that until ']', only something resembling an \r\n\u003e IPv6 address can appear. Then it is checked that the hostname is correctly \r\n\u003e terminated with a ']'. But then, it only validates that a correct port number \r\n\u003e follows if the next char is a ':'. If the next char is anything else, the rest \r\n\u003e of the Host header is not subjected to any kind of check before being stored \r\n\u003e into con-\u003euri.authority.\r\n\r\n\u003e In a lighttpd without anything special, this already means that an attacker can \r\n\u003e sneak spaces into the logfile, potentially confusing logfile parsers. However, \r\n\u003e it gets really interesting when the server uses mod_mysql_vhost (not \r\n\u003e mod_simple_vhost or mod_evhost): con-\u003euri.authority is inserted into an SQL \r\n\u003e query without any escaping, allowing the attacker to control what the database \r\n\u003e responds with - and the response of the database is then taken as document \r\n\u003e root. Therefore, an attacker can change the document root to / for his request \r\n\u003e and thereby effectively perform directory traversal.\r\n\r\nIf one wants to search for uses of con-\u003euri.authority one should also search \r\nfor con-\u003eserver_name.\r\n\r\nh2. Affected versions\r\n\r\nAll versions up to and including 1.4.34.\r\n\r\nh2. Patch\r\n\r\nSee http://download.lighttpd.net/lighttpd/security/lighttpd-1.4.34_fix_mysql_injection.patch\r\n\r\nh2. Fixed in\r\n\r\n1.4.x: http://redmine.lighttpd.net/projects/lighttpd/repository/revisions/2959\r\n1.4.35: https://www.lighttpd.net/2014/3/12/1.4.35/\r\n\r\nh2. Solutions or workaround\r\n\r\n* Disable mod_mysql_vhost.\r\n* Don't use mod_evhost or mod_simple_vhost for IPv6 addresses as host names\r\n  (i.e. don't have and don't allow creation of \"[...]\" directories in the\r\n  base directories)\r\n"
}